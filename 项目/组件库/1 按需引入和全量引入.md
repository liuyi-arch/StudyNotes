🔍 当前实现状态

✅ 已实现全量引入

```javascript
// src/main.ts - 统一入口
export { MyButton } from './components/MyButton'
export { MyCounter } from './components/MyCounter'
export { MyTitle } from './components/MyTitle'

// 用户使用 - 全量引入
import { MyButton, MyCounter, MyTitle } from 'react-vite-component-template'
```

❌ 未完全实现按需引入

虽然 Vite 配置了多入口点构建，但缺少完整的按需引入支持。组件库按需引入实现方案Document 

📊 当前项目按需引入分析

经过代码分析，这个项目 部分实现 了按需引入功能：

✅ 已实现的功能：

Vite 多入口构建 - 为每个组件生成独立的构建产物
Tree Shaking 支持 - 使用 ESM 格式和 sideEffects: false
CSS 自动注入 - 通过 vite-plugin-lib-inject-css

❌ 缺失的功能：

- package.json exports 字段 - 没有配置子路径导出
- 独立组件入口 - 用户无法直接引入单个组件
- Bundle 分析验证 - 缺少 Tree Shaking 效果验证

🛠️ 使用的核心技术

主要工具:

- Vite - 现代构建工具，天然支持 Tree Shaking
- vite-plugin-lib-inject-css - CSS 自动注入
- vite-plugin-dts - TypeScript 声明文件生成
- Rollup - Vite 底层打包器，提供精确的模块分析

关键配置:

- formats: ['es'] - ESM 格式支持 Tree Shaking
- preserveModules: false - 优化 Bundle 大小
- external: ['react', 'react-dom'] - 外部依赖不打包

我提供的完整实现方案可以让项目同时支持：

- 全量引入: import { MyButton } from 'lib' (支持 Tree Shaking)
- 按需引入: import { MyButton } from 'lib/button' (最小 Bundle)

---

# 组件库按需引入和全量引入实现方案

## 📊 当前项目分析

### 现有配置解析

**Vite 多入口配置：**
```javascript
// vite.config.ts - 当前配置
input: Object.fromEntries(
  globSync(['src/components/**/index.tsx', 'src/main.ts']).map((file) => {
    const entryName = path.relative('src', file.slice(0, file.length - path.extname(file).length))
    const entryUrl = fileURLToPath(new URL(file, import.meta.url))
    return [entryName, entryUrl]
  })
)
```

这会生成：
- `main.js` - 全量入口
- `components/MyButton/index.js` - Button 组件
- `components/MyCounter/index.js` - Counter 组件 
- `components/MyTitle/index.js` - Title 组件

### 问题分析

1. **缺少独立导出配置** - package.json 只配置了主入口
2. **没有 ESM 子路径导出** - 用户无法直接引入单个组件
3. **Bundle 分析缺失** - 没有 Tree Shaking 验证

---

## 🚀 完整实现方案

### Step 1: 完善 package.json 配置

```json
{
  "name": "react-vite-component-template",
  "version": "1.0.0",
  "type": "module",
  "main": "./dist/main.js",
  "module": "./dist/main.js",
  "types": "./dist/main.d.ts",
  "exports": {
    ".": {
      "import": "./dist/main.js",
      "require": "./dist/main.cjs",
      "types": "./dist/main.d.ts"
    },
    "./button": {
      "import": "./dist/components/MyButton/index.js",
      "require": "./dist/components/MyButton/index.cjs",
      "types": "./dist/components/MyButton/index.d.ts"
    },
    "./counter": {
      "import": "./dist/components/MyCounter/index.js", 
      "require": "./dist/components/MyCounter/index.cjs",
      "types": "./dist/components/MyCounter/index.d.ts"
    },
    "./title": {
      "import": "./dist/components/MyTitle/index.js",
      "require": "./dist/components/MyTitle/index.cjs", 
      "types": "./dist/components/MyTitle/index.d.ts"
    },
    "./styles/*": "./dist/assets/*.css"
  },
  "files": [
    "dist",
    "README.md"
  ],
  "sideEffects": [
    "*.css"
  ]
}
```

### Step 2: 优化 Vite 构建配置

```javascript
// vite.config.ts - 完整配置
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import dts from 'vite-plugin-dts'
import { libInjectCss } from 'vite-plugin-lib-inject-css'
import { resolve } from 'path'
import { globSync } from 'glob'

export default defineConfig({
  plugins: [
    react(),
    libInjectCss(),
    dts({
      exclude: ['**/*.stories.tsx', 'src/test', '**/*.test.tsx'],
      tsconfigPath: 'tsconfig.app.json',
      // 为每个组件生成单独的类型声明
      rollupTypes: true,
    }),
  ],
  build: {
    lib: {
      entry: {
        // 主入口 - 全量引入
        main: resolve(__dirname, 'src/main.ts'),
        // 组件入口 - 按需引入
        ...Object.fromEntries(
          globSync('src/components/**/index.tsx').map((file) => {
            const entryName = file
              .replace('src/components/', '')
              .replace('/index.tsx', '')
              .toLowerCase()
            return [entryName, resolve(__dirname, file)]
          })
        )
      },
      formats: ['es', 'cjs'],
      fileName: (format, entryName) => {
        if (entryName === 'main') {
          return `main.${format === 'es' ? 'js' : 'cjs'}`
        }
        return `components/${entryName}/index.${format === 'es' ? 'js' : 'cjs'}`
      }
    },
    rollupOptions: {
      external: ['react', 'react-dom', 'react/jsx-runtime'],
      output: {
        preserveModules: false, // 为了更好的 Tree Shaking
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM',
          'react/jsx-runtime': 'react/jsx-runtime',
        },
        // CSS 文件单独输出
        assetFileNames: (assetInfo) => {
          if (assetInfo.name?.endsWith('.css')) {
            return 'assets/[name][extname]'
          }
          return 'assets/[name]-[hash][extname]'
        }
      },
    },
    // 启用 Tree Shaking 优化
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
        pure_funcs: ['console.log']
      }
    }
  }
})
```

### Step 3: 组件导出优化

**每个组件的 index.tsx:**
```javascript
// src/components/MyButton/index.tsx
export { MyButton } from './MyButton'
export type { ComponentProps as MyButtonProps } from './MyButton'

// 如果有样式，确保导出
import './styles.module.css'
```

**主入口优化:**
```javascript
// src/main.ts - 支持 Tree Shaking 的导出
export { MyButton } from './components/MyButton'
export { MyCounter } from './components/MyCounter' 
export { MyTitle } from './components/MyTitle'

// 类型导出
export type { MyButtonProps } from './components/MyButton'
export type { MyCounterProps } from './components/MyCounter'
export type { MyTitleProps } from './components/MyTitle'

// 批量导出（可选）
export * from './components/MyButton'
export * from './components/MyCounter'
export * from './components/MyTitle'
```

### Step 4: 样式按需加载

**CSS Modules 优化:**
```javascript
// 为每个组件创建独立的样式入口
// src/components/MyButton/styles.ts
import styles from './styles.module.css'
export default styles

// 在组件中使用
import styles from './styles'
// 或者
import './styles.module.css' // 自动注入
```

**PostCSS 配置优化:**
```javascript
// postcss.config.cjs
module.exports = {
  plugins: [
    require('autoprefixer'),
    require('cssnano')({
      preset: 'default',
    }),
  ],
}
```

### Step 5: TypeScript 配置优化

**tsconfig.json 更新:**
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext", 
    "moduleResolution": "bundler",
    "declaration": true,
    "declarationMap": true,
    "emitDeclarationOnly": false,
    "outDir": "./dist",
    "preserveModules": true, // 保持模块结构
    "jsx": "react-jsx"
  }
}
```

---

## 🧪 验证和测试

### Bundle 分析工具

```bash
# 安装分析工具
npm install --save-dev rollup-plugin-visualizer webpack-bundle-analyzer

# 在 vite.config.ts 中添加
import { visualizer } from 'rollup-plugin-visualizer'

export default defineConfig({
  plugins: [
    // ... 其他插件
    visualizer({
      filename: 'dist/stats.html',
      open: true,
      gzipSize: true,
      brotliSize: true,
    })
  ]
})
```

### 测试用例

**创建测试项目:**
```javascript
// test-app/package.json
{
  "name": "test-tree-shaking",
  "dependencies": {
    "react-vite-component-template": "file:../dist"
  }
}

// test-app/src/test-full-import.jsx
// 测试全量引入
import { MyButton, MyCounter, MyTitle } from 'react-vite-component-template'

// test-app/src/test-selective-import.jsx  
// 测试按需引入
import { MyButton } from 'react-vite-component-template/button'
import { MyCounter } from 'react-vite-component-template/counter'
```

**Webpack Bundle 分析:**
```javascript
// webpack.config.js
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin

module.exports = {
  plugins: [
    new BundleAnalyzerPlugin({
      analyzerMode: 'server',
      openAnalyzer: true,
    })
  ]
}
```

---

## 📋 使用方式对比

### 全量引入

```javascript
// 方式1：从主入口引入（支持 Tree Shaking）
import { MyButton, MyCounter } from 'react-vite-component-template'

// 方式2：批量引入所有组件
import * as Components from 'react-vite-component-template'
const { MyButton, MyCounter } = Components

// Bundle 大小：包含所有组件代码（但未使用的会被 Tree Shake）
```

### 按需引入

```javascript
// 方式1：子路径引入（推荐）
import { MyButton } from 'react-vite-component-template/button'
import { MyCounter } from 'react-vite-component-template/counter'

// 方式2：直接引入构建产物
import { MyButton } from 'react-vite-component-template/dist/components/MyButton'

// Bundle 大小：只包含使用的组件
```

### 样式引入

```javascript
// 自动注入样式（推荐）
import { MyButton } from 'react-vite-component-template/button'
// CSS 已经自动注入

// 手动引入样式
import { MyButton } from 'react-vite-component-template/button'
import 'react-vite-component-template/styles/MyButton.css'
```

---

## ⚡ 性能优化

### Tree Shaking 验证

```bash
# 构建测试应用
npm run build

# 检查 Bundle 大小
ls -la dist/assets/

# 使用 webpack-bundle-analyzer 分析
npx webpack-bundle-analyzer dist/assets/index-*.js
```

### 预期效果

| 引入方式 | Bundle 大小 | 组件数量 | 加载时间 |
|----------|-------------|----------|----------|
| 全量引入 (Tree Shaking) | ~15KB | 按需 | 快 |
| 按需引入 | ~8KB | 精确 | 最快 |
| 全量引入 (无优化) | ~25KB | 全部 | 慢 |

---

## 🔧 开发工具集成

### Babel 插件支持

```javascript
// babel-plugin-import 配置
// .babelrc.js
module.exports = {
  plugins: [
    [
      'import',
      {
        libraryName: 'react-vite-component-template',
        libraryDirectory: 'dist/components',
        camel2DashComponentName: false,
      },
      'react-vite-component-template'
    ]
  ]
}

// 用户可以这样使用：
import { MyButton } from 'react-vite-component-template'
// 自动转换为：
// import MyButton from 'react-vite-component-template/dist/components/MyButton'
```

### VSCode 智能提示

```json
// .vscode/settings.json
{
  "typescript.preferences.includePackageJsonAutoImports": "on",
  "typescript.suggest.autoImports": true,
  "typescript.suggest.paths": true
}
```

这个实现方案提供了完整的按需引入和全量引入支持，同时保持了良好的开发体验和性能优化。
