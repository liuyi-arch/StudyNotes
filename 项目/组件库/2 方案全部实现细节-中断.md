# React 组件库完整改进方案

## 🎯 项目整体架构升级

### 目标架构
```
react-component-library/
├── packages/
│   ├── components/           # 组件库主包
│   │   ├── src/
│   │   │   ├── components/
│   │   │   │   ├── general/     # 通用组件
│   │   │   │   │   ├── Button/
│   │   │   │   │   ├── Icon/
│   │   │   │   │   └── Typography/
│   │   │   │   ├── data-entry/  # 数据录入组件
│   │   │   │   │   ├── Input/
│   │   │   │   │   ├── Upload/
│   │   │   │   │   ├── AutoComplete/
│   │   │   │   │   └── Select/
│   │   │   │   ├── data-display/ # 数据展示组件
│   │   │   │   │   ├── Table/
│   │   │   │   │   ├── Card/
│   │   │   │   │   └── Avatar/
│   │   │   │   ├── feedback/    # 反馈组件
│   │   │   │   │   ├── Message/
│   │   │   │   │   ├── Loading/
│   │   │   │   │   └── Modal/
│   │   │   │   └── navigation/  # 导航组件
│   │   │   │       ├── Menu/
│   │   │   │       ├── Breadcrumb/
│   │   │   │       └── Pagination/
│   │   │   ├── hooks/          # 自定义 Hooks
│   │   │   ├── utils/          # 工具函数
│   │   │   └── styles/         # 样式系统
│   │   └── package.json
│   ├── tokens/               # 设计令牌
│   ├── utils/               # 共享工具
│   └── docs/                # 文档站点
├── apps/
│   └── storybook/           # Storybook 应用
├── tools/
│   ├── build/               # 构建脚本
│   ├── eslint-config/       # ESLint 配置
│   └── jest-preset/         # Jest 配置
├── pnpm-workspace.yaml
├── package.json
└── README.md
```

---

## 🚀 Phase 1: Monorepo 架构搭建

### 1.1 初始化 pnpm workspace

```yaml
# pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'apps/*'
  - 'tools/*'
```

```json
# package.json (根目录)
{
  "name": "@mylib/react-components",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "pnpm -r --filter='!@mylib/docs' run build",
    "dev": "pnpm -r --parallel run dev",
    "test": "pnpm -r run test",
    "lint": "pnpm -r run lint",
    "format": "prettier --write .",
    "prepare": "husky install",
    "changeset": "changeset",
    "version": "changeset version",
    "publish": "pnpm build && changeset publish",
    "docs:dev": "pnpm --filter @mylib/docs dev",
    "docs:build": "pnpm --filter @mylib/docs build",
    "storybook": "pnpm --filter @mylib/storybook dev",
    "build-storybook": "pnpm --filter @mylib/storybook build"
  },
  "devDependencies": {
    "@changesets/cli": "^2.27.1",
    "@mylib/eslint-config": "workspace:*",
    "@types/node": "^20.10.0",
    "eslint": "^9.0.0",
    "husky": "^9.0.0",
    "lint-staged": "^15.2.0",
    "prettier": "^3.2.0",
    "stylelint": "^16.2.0",
    "typescript": "^5.3.0",
    "vitest": "^1.2.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "pnpm": ">=8.0.0"
  }
}
```

### 1.2 组件库主包配置

```json
# packages/components/package.json
{
  "name": "@mylib/components",
  "version": "1.0.0",
  "description": "React UI Component Library",
  "type": "module",
  "main": "./dist/index.js",
  "module": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./general/*": {
      "import": "./dist/components/general/*/index.js",
      "types": "./dist/components/general/*/index.d.ts"
    },
    "./data-entry/*": {
      "import": "./dist/components/data-entry/*/index.js", 
      "types": "./dist/components/data-entry/*/index.d.ts"
    },
    "./styles/*": "./dist/styles/*",
    "./package.json": "./package.json"
  },
  "files": [
    "dist",
    "README.md"
  ],
  "sideEffects": [
    "*.css",
    "*.scss"
  ],
  "peerDependencies": {
    "react": "^18.0.0 || ^19.0.0",
    "react-dom": "^18.0.0 || ^19.0.0"
  },
  "devDependencies": {
    "@mylib/tokens": "workspace:*",
    "@mylib/utils": "workspace:*",
    "@testing-library/jest-dom": "^6.2.0",
    "@testing-library/react": "^14.1.0",
    "@testing-library/user-event": "^14.5.0",
    "@types/react": "^18.2.0",
    "@vitejs/plugin-react": "^4.2.0",
    "jsdom": "^24.0.0",
    "vite": "^5.0.0",
    "vite-plugin-dts": "^3.7.0",
    "vitest": "^1.2.0"
  }
}
```

---

## 🧩 Phase 2: 组件分类实现

### 2.1 通用组件 - Button

```typescript
// packages/components/src/components/general/Button/Button.tsx
import React from 'react'
import { clsx } from 'clsx'
import { Icon } from '../Icon'
import styles from './Button.module.scss'

export interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  /** 按钮类型 */
  variant?: 'primary' | 'secondary' | 'outline' | 'text' | 'danger'
  /** 按钮尺寸 */
  size?: 'small' | 'medium' | 'large'
  /** 是否为块级按钮 */
  block?: boolean
  /** 加载状态 */
  loading?: boolean
  /** 图标 */
  icon?: React.ReactNode
  /** 图标位置 */
  iconPosition?: 'left' | 'right'
  /** 按钮形状 */
  shape?: 'default' | 'round' | 'circle'
}

export const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  (
    {
      variant = 'primary',
      size = 'medium',
      block = false,
      loading = false,
      icon,
      iconPosition = 'left',
      shape = 'default',
      children,
      className,
      disabled,
      ...props
    },
    ref
  ) => {
    const buttonClass = clsx(
      styles.button,
      styles[`button--${variant}`],
      styles[`button--${size}`],
      {
        [styles['button--block']]: block,
        [styles['button--loading']]: loading,
        [styles[`button--${shape}`]]: shape !== 'default',
        [styles['button--icon-only']]: !children && (icon || loading),
      },
      className
    )

    const iconElement = loading ? <Icon name="loading" spin /> : icon
    
    const content = (
      <>
        {iconElement && iconPosition === 'left' && (
          <span className={styles.button__icon}>{iconElement}</span>
        )}
        {children && <span className={styles.button__text}>{children}</span>}
        {iconElement && iconPosition === 'right' && (
          <span className={styles.button__icon}>{iconElement}</span>
        )}
      </>
    )

    return (
      <button
        ref={ref}
        className={buttonClass}
        disabled={disabled || loading}
        {...props}
      >
        {content}
      </button>
    )
  }
)

Button.displayName = 'Button'
```

### 2.2 数据录入组件 - Upload

```typescript
// packages/components/src/components/data-entry/Upload/Upload.tsx
import React, { useRef, useState } from 'react'
import { clsx } from 'clsx'
import { Button } from '../../general/Button'
import { Icon } from '../../general/Icon'
import styles from './Upload.module.scss'

export interface UploadFile {
  uid: string
  name: string
  size: number
  type: string
  status: 'uploading' | 'done' | 'error'
  percent?: number
  url?: string
  originFileObj?: File
  response?: any
  error?: any
}

export interface UploadProps {
  /** 接受的文件类型 */
  accept?: string
  /** 是否支持多选 */
  multiple?: boolean
  /** 最大文件数量 */
  maxCount?: number
  /** 文件大小限制 */
  maxSize?: number
  /** 文件列表 */
  fileList?: UploadFile[]
  /** 默认文件列表 */
  defaultFileList?: UploadFile[]
  /** 上传前的钩子 */
  beforeUpload?: (file: File, fileList: File[]) => boolean | Promise<boolean>
  /** 自定义上传方法 */
  customRequest?: (options: any) => void
  /** 上传文件改变时的回调 */
  onChange?: (info: { file: UploadFile; fileList: UploadFile[] }) => void
  /** 点击移除文件时的回调 */
  onRemove?: (file: UploadFile) => boolean | Promise<boolean>
  /** 上传列表的内建样式 */
  listType?: 'text' | 'picture' | 'picture-card'
  /** 是否禁用 */
  disabled?: boolean
  /** 拖拽上传 */
  dragable?: boolean
  children?: React.ReactNode
}

export const Upload: React.FC<UploadProps> = ({
  accept,
  multiple = false,
  maxCount = Infinity,
  maxSize,
  fileList,
  defaultFileList = [],
  beforeUpload,
  customRequest,
  onChange,
  onRemove,
  listType = 'text',
  disabled = false,
  dragable = false,
  children,
}) => {
  const [internalFileList, setInternalFileList] = useState<UploadFile[]>(
    fileList || defaultFileList
  )
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [dragOver, setDragOver] = useState(false)

  const currentFileList = fileList || internalFileList

  const handleClick = () => {
    if (disabled) return
    fileInputRef.current?.click()
  }

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || [])
    await processFiles(files)
    // 清空 input 值，允许重复选择同一文件
    if (fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }

  const handleDrop = async (event: React.DragEvent) => {
    event.preventDefault()
    setDragOver(false)
    
    if (disabled) return
    
    const files = Array.from(event.dataTransfer.files)
    await processFiles(files)
  }

  const processFiles = async (files: File[]) => {
    for (const file of files) {
      if (currentFileList.length >= maxCount) {
        console.warn('超出最大文件数量限制')
        break
      }

      // 文件大小检查
      if (maxSize && file.size > maxSize) {
        console.warn(`文件 ${file.name} 大小超出限制`)
        continue
      }

      // 上传前钩子检查
      if (beforeUpload) {
        const shouldUpload = await beforeUpload(file, files)
        if (!shouldUpload) continue
      }

      const uploadFile: UploadFile = {
        uid: `${Date.now()}-${Math.random()}`,
        name: file.name,
        size: file.size,
        type: file.type,
        status: 'uploading',
        percent: 0,
        originFileObj: file,
      }

      const newFileList = [...currentFileList, uploadFile]
      
      if (!fileList) {
        setInternalFileList(newFileList)
      }
      
      onChange?.({ file: uploadFile, fileList: newFileList })

      // 执行上传
      if (customRequest) {
        customRequest({
          file,
          onProgress: (percent: number) => {
            const updatedFile = { ...uploadFile, percent }
            updateFileInList(uploadFile.uid, updatedFile)
          },
          onSuccess: (response: any) => {
            const updatedFile = { 
              ...uploadFile, 
              status: 'done' as const, 
              percent: 100,
              response 
            }
            updateFileInList(uploadFile.uid, updatedFile)
          },
          onError: (error: any) => {
            const updatedFile = { 
              ...uploadFile, 
              status: 'error' as const, 
              error 
            }
            updateFileInList(uploadFile.uid, updatedFile)
          },
        })
      }
    }
  }

  const updateFileInList = (uid: string, updatedFile: UploadFile) => {
    const newFileList = currentFileList.map(file => 
      file.uid === uid ? updatedFile : file
    )
    
    if (!fileList) {
      setInternalFileList(newFileList)
    }
    
    onChange?.({ file: updatedFile, fileList: newFileList })
  }

  const handleRemove = async (file: UploadFile) => {
    if (onRemove) {
      const shouldRemove = await onRemove(file)
      if (!shouldRemove) return
    }

    const newFileList = currentFileList.filter(item => item.uid !== file.uid)
    
    if (!fileList) {
      setInternalFileList(newFileList)
    }
    
    onChange?.({ file, fileList: newFileList })
  }

  const uploadClass = clsx(
    styles.upload,
    styles[`upload--${listType}`],
    {
      [styles['upload--disabled']]: disabled,
      [styles['upload--drag']]: dragable,
      [styles['upload--drag-over']]: dragOver,
    }
  )

  const renderUploadButton = () => {
    if (listType === 'picture-card') {
      return (
        <div className={styles['upload-select']}>
          <Icon name="plus" />
          <div className={styles['upload-text']}>Upload</div>
        </div>
      )
    }

    return children || (
      <Button icon={<Icon name="upload" />} disabled={disabled}>
        点击上传
      </Button>
    )
  }

  const renderFileList = () => {
    if (!currentFileList.length) return null

    return (
      <div className={styles['upload-list']}>
        {currentFileList.map(file => (
          <div key={file.uid} className={styles['upload-list-item']}>
            <div className={styles['upload-list-item-info']}>
              <Icon name={getFileIcon(file.type)} />
              <span className={styles['upload-list-item-name']}>{file.name}</span>
              {file.status === 'uploading' && (
                <div className={styles['upload-progress']}>
                  <div 
                    className={styles['upload-progress-bar']}
                    style={{ width: `${file.percent}%` }}
                  />
                </div>
              )}
            </div>
            <div className={styles['upload-list-item-actions']}>
              {file.status === 'done' && file.url && (
                <Icon name="eye" onClick={() => window.open(file.url)} />
              )}
              <Icon 
                name="delete" 
                onClick={() => handleRemove(file)} 
              />
            </div>
          </div>
        ))}
      </div>
    )
  }

  const getFileIcon = (fileType: string): string => {
    if (fileType.startsWith('image/')) return 'file-image'
    if (fileType.includes('pdf')) return 'file-pdf'
    if (fileType.includes('word')) return 'file-word'
    return 'file'
  }

  return (
    <div className={uploadClass}>
      <input
        ref={fileInputRef}
        type="file"
        accept={accept}
        multiple={multiple}
        onChange={handleFileChange}
        style={{ display: 'none' }}
      />
      
      {dragable ? (
        <div
          className={styles['upload-drag']}
          onClick={handleClick}
          onDrop={handleDrop}
          onDragOver={(e) => {
            e.preventDefault()
            setDragOver(true)
          }}
          onDragLeave={() => setDragOver(false)}
        >
          <div className={styles['upload-drag-content']}>
            <Icon name="inbox" size="large" />
            <p>点击或拖拽文件到此区域上传</p>
          </div>
        </div>
      ) : (
        <div onClick={handleClick}>
          {renderUploadButton()}
        </div>
      )}
      
      {renderFileList()}
    </div>
  )
}

const getFileIcon = (fileType: string): string => {
  if (fileType.startsWith('image/')) return 'file-image'
  if (fileType.includes('pdf')) return 'file-pdf'
  if (fileType.includes('word')) return 'file-word'
  return 'file'
}
```

### 2.3 数据录入组件 - AutoComplete

```typescript
// packages/components/src/components/data-entry/AutoComplete/AutoComplete.tsx
import React, { useState, useRef, useEffect } from 'react'
import { clsx } from 'clsx'
import { Input } from '../Input'
import { useClickOutside } from '../../../hooks/useClickOutside'
import styles from './AutoComplete.module.scss'

export interface AutoCompleteOption {
  label: string
  value: string
  disabled?: boolean
  [key: string]: any
}

export interface AutoCompleteProps {
  /** 输入框值 */
  value?: string
  /** 默认值 */
  defaultValue?: string
  /** 数据源 */
  options?: AutoCompleteOption[]
  /** 输入框占位符 */
  placeholder?: string
  /** 是否禁用 */
  disabled?: boolean
  /** 是否显示清除按钮 */
  allowClear?: boolean
  /** 输入框变化回调 */
  onChange?: (value: string) => void
  /** 选择选项回调 */
  onSelect?: (value: string, option: AutoCompleteOption) => void
  /** 搜索回调 */
  onSearch?: (value: string) => void
  /** 自定义过滤方法 */
  filterOption?: (inputValue: string, option: AutoCompleteOption) => boolean
  /** 自定义渲染选项 */
  renderOption?: (option: AutoCompleteOption) => React.ReactNode
  /** 无数据时显示内容 */
  notFoundContent?: React.ReactNode
  /** 最大显示选项数 */
  maxCount?: number
  /** 输入框尺寸 */
  size?: 'small' | 'medium' | 'large'
}

export const AutoComplete: React.FC<AutoCompleteProps> = ({
  value,
  defaultValue = '',
  options = [],
  placeholder,
  disabled = false,
  allowClear = false,
  onChange,
  onSelect,
  onSearch,
  filterOption,
  renderOption,
  notFoundContent = '无匹配结果',
  maxCount = 50,
  size = 'medium',
}) => {
  const [internalValue, setInternalValue] = useState(value || defaultValue)
  const [isOpen, setIsOpen] = useState(false)
  const [activeIndex, setActiveIndex] = useState(-1)
  
  const containerRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)
  const listRef = useRef<HTMLUListElement>(null)

  const currentValue = value !== undefined ? value : internalValue

  useClickOutside(containerRef, () => {
    setIsOpen(false)
    setActiveIndex(-1)
  })

  // 过滤选项
  const filteredOptions = React.useMemo(() => {
    if (!currentValue.trim()) return options.slice(0, maxCount)

    const filtered = options.filter(option => {
      if (filterOption) {
        return filterOption(currentValue, option)
      }
      return option.label.toLowerCase().includes(currentValue.toLowerCase())
    })

    return filtered.slice(0, maxCount)
  }, [currentValue, options, filterOption, maxCount])

  // 处理输入变化
  const handleInputChange = (inputValue: string) => {
    if (value === undefined) {
      setInternalValue(inputValue)
    }
    onChange?.(inputValue)
    onSearch?.(inputValue)
    
    setIsOpen(true)
    setActiveIndex(-1)
  }

  // 处理选项选择
  const handleOptionSelect = (option: AutoCompleteOption) => {
    if (option.disabled) return

    const newValue = option.value
    
    if (value === undefined) {
      setInternalValue(newValue)
    }
    
    onChange?.(newValue)
    onSelect?.(newValue, option)
    setIsOpen(false)
    setActiveIndex(-1)
    
    // 聚焦输入框
    inputRef.current?.focus()
  }

  // 处理键盘导航
  const handleKeyDown = (event: React.KeyboardEvent) => {
    const { key } = event

    if (!isOpen) {
      if (key === 'ArrowDown' || key === 'Enter') {
        setIsOpen(true)
        return
      }
      return
    }

    switch (key) {
      case 'ArrowDown':
        event.preventDefault()
        setActiveIndex(prev => 
          prev < filteredOptions.length - 1 ? prev + 1 : 0
        )
        break

      case 'ArrowUp':
        event.preventDefault()
        setActiveIndex(prev => 
          prev > 0 ? prev - 1 : filteredOptions.length - 1
        )
        break

      case 'Enter':
        event.preventDefault()
        if (activeIndex >= 0 && filteredOptions[activeIndex]) {
          handleOptionSelect(filteredOptions[activeIndex])
        }
        break

      case 'Escape':
        setIsOpen(false)
        setActiveIndex(-1)
        break

      case 'Tab':
        setIsOpen(false)
        setActiveIndex(-1)
        break
    }
  }

  // 滚动活跃选项到视图中
  useEffect(() => {
    if (activeIndex >= 0 && listRef.current) {
      const activeElement = listRef.current.children[activeIndex] as HTMLElement
      if (activeElement) {
        activeElement.scrollIntoView({
          block: 'nearest',
          inline: 'nearest',
        })
      }
    }
  }, [activeIndex])

  // 渲染选项
  const renderOptions = () => {
    if (!isOpen) return null

    if (filteredOptions.length === 0) {
      return (
        <div className={styles['autocomplete-dropdown']}>
          <div className={styles['autocomplete-empty']}>
            {notFoundContent}
          </div>
        </div>
      )
    }

    return (
      <div className={styles['autocomplete-dropdown']}>
        <ul ref={listRef} className={styles['autocomplete-list']}>
          {filteredOptions.map((option, index) => {
            const isActive = index === activeIndex
            const optionClass = clsx(
              styles['autocomplete-option'],
              {
                [styles['autocomplete-option--active']]: isActive,
                [styles['autocomplete-option--disabled']]: option.disabled,
              }
            )

            return (
              <li
                key={option.value}
                className={optionClass}
                onClick={() => handleOptionSelect(option)}
                onMouseEnter={() => setActiveIndex(index)}
              >
                {renderOption ? renderOption(option) : option.label}
              </li>
            )
          })}
        </ul>
      </div>
    )
  }

  return (
    <div 
      ref={containerRef}
      className={clsx(styles.autocomplete, {
        [styles['autocomplete--open']]: isOpen,
      })}
    >
      <Input
        ref={inputRef}
        value={currentValue}
        placeholder={placeholder}
        disabled={disabled}
        allowClear={allowClear}
        size={size}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        onFocus={() => setIsOpen(true)}
        autoComplete="off"
      />
      {renderOptions()}
    </div>
  )
}
```

---

## 🛠️ Phase 3: 代码质量工具配置

### 3.1 ESLint v9 平面配置

```javascript
// tools/eslint-config/index.js
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import eslintConfigPrettier from 'eslint-config-prettier'
import react from 'eslint-plugin-react'

export default tseslint.config(
  { 
    ignores: [
      'dist',
      'node_modules',
      '.storybook',
      'coverage',
      '**/*.d.ts'
    ] 
  },
  {
    extends: [
      js.configs.recommended,
      ...tseslint.configs.recommended,
      ...tseslint.configs.recommendedTypeChecked,
      eslintConfigPrettier
    ],
    files: ['**/*.{ts,tsx,js,jsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: {
        ...globals.browser,
        ...globals.node,
      },
      parserOptions: {
        project: ['./tsconfig.json', './packages/*/tsconfig.json'],
        tsconfigRootDir: import.meta.dirname,
      },
    },
    plugins: {
      react,
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
      'react/react-in-jsx-scope': 'off',
      'react/prop-types': 'off',
      '@typescript-eslint/no-unused-vars': [
        'warn',
        { argsIgnorePattern: '^_' }
      ],
      '@typescript-eslint/explicit-function-return-type': 'off',
      '@typescript-eslint/explicit-module-boundary-types': 'off',
      '@typescript-eslint/no-explicit-any': 'warn',
      '@typescript-eslint/prefer-const': 'error',
      'prefer-const': 'error',
      'no-var': 'error',
    },
    settings: {
      react: {
        version: 'detect',
      },
    },
  },
  {
    files: ['**/*.test.{ts,tsx}', '**/*.spec.{ts,tsx}'],
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
    },
  }
)
```

### 3.2 Stylelint 配置

```javascript
// tools/stylelint-config/index.js  
export default {
  extends: [
    'stylelint-config-standard-scss',
    'stylelint-config-prettier-scss'
  ],
  rules: {
    'selector-class-pattern': [
      '^[a-z]([a-z0-9-]+)?(__([a-z0-9]+-?)+)?(--([a-z0-9]+-?)+){0,2}$',
      {
        message: 'Expected class selector to be kebab-case with BEM methodology'
      }
    ],
    'scss/at-rule-no-unknown': [
      true,
      {
        ignoreAtRules: ['tailwind', 'apply', 'layer']
      }
    ],
    'custom-property-pattern': '^[a-z]([a-z0-9-]+)*$',
    'keyframes-name-pattern': '^[a-z]([a-z0-9-]+)*$',
    'scss/dollar-variable-pattern': '^[a-z]([a-z0-9-]+)*$',
    'scss/percent-placeholder-pattern': '^[a-z]([
